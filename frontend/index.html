<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Procurement System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .login-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        padding: 40px;
        width: 100%;
        max-width: 400px;
      }
      .login-card h2 {
        color: #333;
        margin-bottom: 30px;
        text-align: center;
      }
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 12px;
        font-weight: 600;
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%);
      }
    </style>
  </head>
  <body>
    <div class="login-card">
      <h2>üîê Login</h2>
      <div id="loginForm">
        <div class="mb-3">
          <label for="username" class="form-label">Username</label>
          <input
            type="text"
            class="form-control"
            id="username"
            placeholder="Enter username"
            autocomplete="off"
          />
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">Password</label>
          <input
            type="password"
            class="form-control"
            id="password"
            placeholder="Enter password"
            autocomplete="off"
          />
        </div>
        <button type="button" class="btn btn-primary w-100" id="loginBtn">
          <span class="btn-text">Login</span>
          <span
            class="spinner-border spinner-border-sm d-none"
            role="status"
          ></span>
        </button>
      </div>
      <hr />
      <p class="text-center text-muted mb-0">
        Don't have an account? <a href="register.html">Register here</a>
      </p>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script>
      $(document).ready(function () {
        // Check if already logged in
        if (getToken()) {
          window.location.href = "dashboard.html";
          return;
        }

        // Configure toastr
        toastr.options = {
          closeButton: true,
          progressBar: true,
          positionClass: "toast-top-right",
          timeOut: 5000,
        };

        // Unified login handler
        function handleLogin() {
          const username = $("#username").val().trim();
          const password = $("#password").val().trim();

          if (!username || !password) {
            toastr.warning("Please fill in all fields");
            return;
          }

          // Show loading state
          const $btn = $("#loginBtn");
          $btn.prop("disabled", true);
          $btn.find(".btn-text").text("Logging in...");
          $btn.find(".spinner-border").removeClass("d-none");

          // Make login request
          api
            .post("/auth/login", { username, password })
            .done(function (response) {
              if (response.success) {
                setToken(response.data.token);
                setUser(response.data.user);
                toastr.success("Login successful! Redirecting...");
                setTimeout(function () {
                  window.location.href = "dashboard.html";
                }, 1000);
              } else {
                toastr.error(response.message || "Login failed");
              }
            })
            .fail(function (xhr) {
              const message =
                xhr.responseJSON?.message || "Login failed. Please try again.";
              toastr.error(message);
            })
            .always(function () {
              $btn.prop("disabled", false);
              $btn.find(".btn-text").text("Login");
              $btn.find(".spinner-border").addClass("d-none");
            });
        }

        // Remove all previous click/keydown handlers to avoid double binding
        $("#loginBtn").off("click");
        $("#loginForm input").off("keydown");

        $("#loginBtn").on("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          handleLogin();
        });

        $("#loginForm input").on("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            handleLogin();
          }
        });
      });
    </script>
  </body>
</html>
