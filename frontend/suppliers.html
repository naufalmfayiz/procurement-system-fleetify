<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Suppliers - Procurement System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css"
      rel="stylesheet"
    />
    <link href="css/style.css" rel="stylesheet" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="dashboard.html">
          <i class="bi bi-box-seam"></i> Procurement System
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">
                <i class="bi bi-speedometer2"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="items.html">
                <i class="bi bi-box"></i> Items
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="suppliers.html">
                <i class="bi bi-building"></i> Suppliers
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="purchase.html">
                <i class="bi bi-cart-plus"></i> New Purchase
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="history.html">
                <i class="bi bi-clock-history"></i> History
              </a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
              >
                <i class="bi bi-person-circle"></i>
                <span id="username">User</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Logout
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-building"></i> Suppliers Management</h2>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#supplierModal"
          onclick="openAddModal()"
        >
          <i class="bi bi-plus-lg"></i> Add Supplier
        </button>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Address</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="suppliersTableBody">
                <tr>
                  <td colspan="5" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Supplier Modal -->
    <div class="modal fade" id="supplierModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Add Supplier</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form id="supplierForm">
            <div class="modal-body">
              <input type="hidden" id="supplierId" />
              <div class="mb-3">
                <label for="supplierName" class="form-label">Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="supplierName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="supplierEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="supplierEmail" />
              </div>
              <div class="mb-3">
                <label for="supplierAddress" class="form-label">Address</label>
                <textarea
                  class="form-control"
                  id="supplierAddress"
                  rows="3"
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary" id="saveBtn">
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Delete</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              Are you sure you want to delete
              <strong id="deleteSupplierName"></strong>?
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script>
      let supplierModal, deleteModal;
      let deleteSupplierId = null;

      $(document).ready(function () {
        if (!requireAuth()) return;

        const user = getUser();
        if (user) $("#username").text(user.username);

        toastr.options = {
          closeButton: true,
          progressBar: true,
          positionClass: "toast-top-right",
          timeOut: 3000,
        };

        // Initialize modals
        supplierModal = new bootstrap.Modal(
          document.getElementById("supplierModal")
        );
        deleteModal = new bootstrap.Modal(
          document.getElementById("deleteModal")
        );

        loadSuppliers();

        // Form submission
        $("#supplierForm").on("submit", function (e) {
          e.preventDefault();
          saveSupplier();
        });

        // Event Delegation for dynamically created buttons
        $(document).on("click", ".btn-delete", function () {
          const id = $(this).data("id");
          const name = $(this).data("name");
          openDeleteModal(id, name);
        });

        $(document).on("click", ".btn-edit", function () {
          const id = $(this).data("id");
          openEditModal(id);
        });

        $("#confirmDeleteBtn").on("click", function () {
          deleteSupplier();
        });
      });

      function loadSuppliers() {
        api
          .get("/suppliers")
          .done(function (response) {
            if (response.success) {
              renderSuppliersTable(response.data || []);
            }
          })
          .fail(function () {
            toastr.error("Failed to load suppliers");
          });
      }

      function renderSuppliersTable(suppliers) {
        const $tbody = $("#suppliersTableBody");
        $tbody.empty();

        if (suppliers.length === 0) {
          $tbody.html(
            '<tr><td colspan="5" class="text-center text-muted">No suppliers found</td></tr>'
          );
          return;
        }

        suppliers.forEach(function (supplier) {
          const row = `
                    <tr>
                        <td>${supplier.id}</td>
                        <td>${escapeHtml(supplier.name)}</td>
                        <td>${escapeHtml(supplier.email || "-")}</td>
                        <td>${escapeHtml(supplier.address || "-")}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-edit" data-id="${
                              supplier.id
                            }">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${
                              supplier.id
                            }" data-name="${escapeHtml(supplier.name)}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
          $tbody.append(row);
        });
      }

      function openAddModal() {
        $("#modalTitle").text("Add Supplier");
        $("#supplierId").val("");
        $("#supplierForm")[0].reset();
      }

      function openEditModal(id) {
        api
          .get("/suppliers/" + id)
          .done(function (response) {
            if (response.success) {
              const supplier = response.data;
              $("#modalTitle").text("Edit Supplier");
              $("#supplierId").val(supplier.id);
              $("#supplierName").val(supplier.name);
              $("#supplierEmail").val(supplier.email);
              $("#supplierAddress").val(supplier.address);
              supplierModal.show();
            }
          })
          .fail(function () {
            toastr.error("Failed to load supplier data");
          });
      }

      function saveSupplier() {
        const id = $("#supplierId").val();
        const data = {
          name: $("#supplierName").val().trim(),
          email: $("#supplierEmail").val().trim(),
          address: $("#supplierAddress").val().trim(),
        };

        const request = id
          ? api.put("/suppliers/" + id, data)
          : api.post("/suppliers", data);

        request
          .done(function (response) {
            if (response.success) {
              toastr.success(
                id
                  ? "Supplier updated successfully"
                  : "Supplier created successfully"
              );
              supplierModal.hide();
              loadSuppliers();
            } else {
              toastr.error(response.message || "Operation failed");
            }
          })
          .fail(function (xhr) {
            const message = xhr.responseJSON?.message || "Operation failed";
            toastr.error(message);
          });
      }

      function openDeleteModal(id, name) {
        deleteSupplierId = id;
        $("#deleteSupplierName").text(name);
        deleteModal.show();
      }

      function deleteSupplier() {
        if (!deleteSupplierId) return;

        api
          .delete("/suppliers/" + deleteSupplierId)
          .done(function (response) {
            if (response.success) {
              toastr.success("Supplier deleted successfully");
              deleteModal.hide();
              loadSuppliers();
            } else {
              toastr.error(response.message || "Delete failed");
            }
          })
          .fail(function (xhr) {
            const message = xhr.responseJSON?.message || "Delete failed";
            toastr.error(message);
          });
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
