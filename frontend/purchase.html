<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Purchase - Procurement System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css"
      rel="stylesheet"
    />
    <link href="css/style.css" rel="stylesheet" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="dashboard.html">
          <i class="bi bi-box-seam"></i> Procurement System
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">
                <i class="bi bi-speedometer2"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="items.html">
                <i class="bi bi-box"></i> Items
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="suppliers.html">
                <i class="bi bi-building"></i> Suppliers
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="purchase.html">
                <i class="bi bi-cart-plus"></i> New Purchase
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="history.html">
                <i class="bi bi-clock-history"></i> History
              </a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
              >
                <i class="bi bi-person-circle"></i>
                <span id="username">User</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Logout
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
      <h2 class="mb-4"><i class="bi bi-cart-plus"></i> Create New Purchase</h2>

      <div class="row">
        <!-- Left Column - Add Item Form -->
        <div class="col-md-5">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-plus-circle"></i> Add Item to Cart
              </h5>
            </div>
            <div class="card-body">
              <!-- Supplier Selection -->
              <div class="mb-3">
                <label for="supplierSelect" class="form-label"
                  >Select Supplier *</label
                >
                <select class="form-select" id="supplierSelect" required>
                  <option value="">-- Select Supplier --</option>
                </select>
              </div>

              <hr />

              <!-- Item Selection -->
              <div class="mb-3">
                <label for="itemSelect" class="form-label">Select Item *</label>
                <select class="form-select" id="itemSelect" required>
                  <option value="">-- Select Item --</option>
                </select>
              </div>

              <!-- Item Info Display -->
              <div id="itemInfo" class="mb-3 d-none">
                <div class="alert alert-info mb-0">
                  <small>
                    <strong>Price:</strong> <span id="itemPrice">-</span><br />
                    <strong>Available Stock:</strong>
                    <span id="itemStock">-</span>
                  </small>
                </div>
              </div>

              <!-- Quantity -->
              <div class="mb-3">
                <label for="itemQty" class="form-label">Quantity *</label>
                <input
                  type="number"
                  class="form-control"
                  id="itemQty"
                  min="1"
                  value="1"
                  required
                />
              </div>

              <button
                type="button"
                class="btn btn-success w-100"
                id="addToCartBtn"
              >
                <i class="bi bi-cart-plus"></i> Add to Cart
              </button>
            </div>
          </div>
        </div>

        <!-- Right Column - Cart -->
        <div class="col-md-7">
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0"><i class="bi bi-cart3"></i> Shopping Cart</h5>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                id="clearCartBtn"
              >
                <i class="bi bi-trash"></i> Clear Cart
              </button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover" id="cartTable">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th class="text-center">Qty</th>
                      <th class="text-end">Price</th>
                      <th class="text-end">Subtotal</th>
                      <th class="text-center">Action</th>
                    </tr>
                  </thead>
                  <tbody id="cartTableBody">
                    <tr id="emptyCartRow">
                      <td colspan="5" class="text-center text-muted py-4">
                        <i class="bi bi-cart-x fs-1 d-block mb-2"></i>
                        Cart is empty
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Cart Summary -->
              <div class="cart-summary mt-3">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>Total Items:</strong> <span id="totalItems">0</span>
                  </div>
                  <div>
                    <h4 class="mb-0">
                      Grand Total: <span id="grandTotal">Rp 0</span>
                    </h4>
                  </div>
                </div>
              </div>

              <hr />

              <!-- Submit Button -->
              <button
                type="button"
                class="btn btn-primary btn-lg w-100"
                id="submitOrderBtn"
                disabled
              >
                <i class="bi bi-check-circle"></i> Submit Order
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">
              <i class="bi bi-check-circle"></i> Order Successful
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body text-center">
            <i
              class="bi bi-check-circle-fill text-success"
              style="font-size: 4rem"
            ></i>
            <h4 class="mt-3">Order Created Successfully!</h4>
            <p class="text-muted">Order ID: <strong id="orderId">-</strong></p>
          </div>
          <div class="modal-footer">
            <a href="history.html" class="btn btn-primary">View History</a>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
              onclick="resetPage()"
            >
              Create New Order
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script>
      // Shopping Cart (stored locally, not sent to server until submit)
      let cart = [];
      let items = [];
      let suppliers = [];
      let successModal;

      $(document).ready(function () {
        if (!requireAuth()) return;

        const user = getUser();
        if (user) $("#username").text(user.username);

        toastr.options = {
          closeButton: true,
          progressBar: true,
          positionClass: "toast-top-right",
          timeOut: 3000,
        };

        // Initialize modal
        successModal = new bootstrap.Modal(
          document.getElementById("successModal")
        );

        // Load data
        loadSuppliers();
        loadItems();

        // Event handlers
        $("#itemSelect").on("change", function () {
          showItemInfo();
        });

        $("#addToCartBtn").on("click", function () {
          addToCart();
        });

        // Event Delegation for dynamically created remove buttons
        $(document).on("click", ".btn-remove-item", function () {
          const index = $(this).data("index");
          removeFromCart(index);
        });

        $("#clearCartBtn").on("click", function () {
          clearCart();
        });

        $("#submitOrderBtn").on("click", function () {
          submitOrder();
        });
      });

      function loadSuppliers() {
        api
          .get("/suppliers")
          .done(function (response) {
            if (response.success) {
              suppliers = response.data || [];
              const $select = $("#supplierSelect");
              $select.find("option:not(:first)").remove();

              suppliers.forEach(function (supplier) {
                $select.append(
                  `<option value="${supplier.id}">${escapeHtml(
                    supplier.name
                  )}</option>`
                );
              });
            }
          })
          .fail(function () {
            toastr.error("Failed to load suppliers");
          });
      }

      function loadItems() {
        api
          .get("/items")
          .done(function (response) {
            if (response.success) {
              items = response.data || [];
              const $select = $("#itemSelect");
              $select.find("option:not(:first)").remove();

              items.forEach(function (item) {
                const stockInfo =
                  item.stock > 0 ? `(Stock: ${item.stock})` : "(Out of Stock)";
                $select.append(
                  `<option value="${item.id}" ${
                    item.stock === 0 ? "disabled" : ""
                  }>${escapeHtml(item.name)} ${stockInfo}</option>`
                );
              });
            }
          })
          .fail(function () {
            toastr.error("Failed to load items");
          });
      }

      function showItemInfo() {
        const itemId = parseInt($("#itemSelect").val());
        if (!itemId) {
          $("#itemInfo").addClass("d-none");
          return;
        }

        const item = items.find((i) => i.id === itemId);
        if (item) {
          $("#itemPrice").text(formatCurrency(item.price));
          $("#itemStock").text(item.stock);
          $("#itemInfo").removeClass("d-none");
          $("#itemQty").attr("max", item.stock);
        }
      }

      function addToCart() {
        const supplierId = parseInt($("#supplierSelect").val());
        const itemId = parseInt($("#itemSelect").val());
        const qty = parseInt($("#itemQty").val());

        // Validation
        if (!supplierId) {
          toastr.warning("Please select a supplier");
          return;
        }

        if (!itemId) {
          toastr.warning("Please select an item");
          return;
        }

        if (!qty || qty < 1) {
          toastr.warning("Please enter a valid quantity");
          return;
        }

        // Find item details
        const item = items.find((i) => i.id === itemId);
        if (!item) {
          toastr.error("Item not found");
          return;
        }

        // Check stock (including items already in cart)
        const existingCartItem = cart.find((c) => c.item_id === itemId);
        const currentCartQty = existingCartItem ? existingCartItem.qty : 0;

        if (currentCartQty + qty > item.stock) {
          toastr.error(
            `Insufficient stock! Available: ${item.stock - currentCartQty}`
          );
          return;
        }

        // Add to cart or update quantity if already exists
        if (existingCartItem) {
          existingCartItem.qty += qty;
          existingCartItem.subtotal = existingCartItem.qty * item.price;
        } else {
          cart.push({
            item_id: item.id,
            item_name: item.name,
            qty: qty,
            price: item.price,
            subtotal: qty * item.price,
          });
        }

        toastr.success(`${item.name} added to cart`);

        // Reset item selection
        $("#itemSelect").val("");
        $("#itemQty").val(1);
        $("#itemInfo").addClass("d-none");

        // Update cart display
        renderCart();
      }

      function removeFromCart(index) {
        const item = cart[index];
        cart.splice(index, 1);
        toastr.info(`${item.item_name} removed from cart`);
        renderCart();
      }

      function clearCart() {
        if (cart.length === 0) return;

        cart = [];
        toastr.info("Cart cleared");
        renderCart();
      }

      function renderCart() {
        const $tbody = $("#cartTableBody");
        $tbody.empty();

        if (cart.length === 0) {
          $tbody.html(`
                    <tr id="emptyCartRow">
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="bi bi-cart-x fs-1 d-block mb-2"></i>
                            Cart is empty
                        </td>
                    </tr>
                `);
          $("#totalItems").text("0");
          $("#grandTotal").text("Rp 0");
          $("#submitOrderBtn").prop("disabled", true);
          return;
        }

        let totalItems = 0;
        let grandTotal = 0;

        cart.forEach(function (item, index) {
          totalItems += item.qty;
          grandTotal += item.subtotal;

          const row = `
                    <tr>
                        <td>${escapeHtml(item.item_name)}</td>
                        <td class="text-center">${item.qty}</td>
                        <td class="text-end">${formatCurrency(item.price)}</td>
                        <td class="text-end">${formatCurrency(
                          item.subtotal
                        )}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger btn-remove-item" data-index="${index}">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </td>
                    </tr>
                `;
          $tbody.append(row);
        });

        $("#totalItems").text(totalItems);
        $("#grandTotal").text(formatCurrency(grandTotal));
        $("#submitOrderBtn").prop("disabled", false);
      }

      function submitOrder() {
        const supplierId = parseInt($("#supplierSelect").val());

        if (!supplierId) {
          toastr.error("Please select a supplier");
          return;
        }

        if (cart.length === 0) {
          toastr.error("Cart is empty");
          return;
        }

        // Disable button and show loading
        const $btn = $("#submitOrderBtn");
        $btn.prop("disabled", true);
        $btn.html(
          '<span class="spinner-border spinner-border-sm me-2"></span>Processing...'
        );

        // Prepare payload - only send item_id and qty
        // Price calculation will be done by backend!
        const payload = {
          supplier_id: supplierId,
          items: cart.map((item) => ({
            item_id: item.item_id,
            qty: item.qty,
          })),
        };

        // Submit to API
        api
          .post("/purchases", payload)
          .done(function (response) {
            if (response.success) {
              $("#orderId").text(response.data.id);
              successModal.show();

              // Reset cart
              cart = [];
              renderCart();

              // Reload items to get updated stock
              loadItems();
            } else {
              toastr.error(response.message || "Failed to create order");
            }
          })
          .fail(function (xhr) {
            const message =
              xhr.responseJSON?.message ||
              "Failed to create order. Please try again.";
            toastr.error(message);
          })
          .always(function () {
            $btn.prop("disabled", cart.length === 0);
            $btn.html('<i class="bi bi-check-circle"></i> Submit Order');
          });
      }

      function resetPage() {
        $("#supplierSelect").val("");
        $("#itemSelect").val("");
        $("#itemQty").val(1);
        $("#itemInfo").addClass("d-none");
        cart = [];
        renderCart();
        loadItems();
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
